# A5: Relational Schema, Validation and Schema Refinement

This artefact’s purpose is to describe the Relational Schema obtained from the Conceptual Data Model in order to implement the database.

## 5.1 Relational Schema

The following table represents our relational schema.

| Relation reference  | Relation Compact Notation |
| --- | --- |
| R01 | administrator(**id**, username UK NN, password NN, last_login NN DF current_date CK last_login <= current_date) |
| R02 | user(**id**, username UK NN, email UK NN LK "%@%.%", password NN, name NN, profile_pic,  account_creation_date NN DF current_date CK account_creation_date <= current_date, birthdate NN CK birthdate <= account_creation_date, description, block_motive) |
| R03 | unblock_appeal(**id_user** -> user, message NN) |
| R04 | event(**id**, id_host -> user NN, title NN, event_image NN, description NN, location NN, creation_date NN DF current_date CK creation_date <= current_date, realization_date NN CK realization_date > creation_date, is_visible NN, is_acessible NN, capacity NN CK capacity > 0, price NN DF 0 CK price >= 0, number_attendees NN DF 0 CK number_attendees >= 0 AND number_attendees <= capacity) |
| R05 | tag(**id**, name UK NN) |
| R06 | post(**id**, title NN, description NN, creation_date NN DF current_date CK creation_date <= current_date, id_event -> event NN)|
| R07 | poll(**id_post** -> post) |
| R08 | option(**id**, id_poll -> poll NN, description NN, votes NN DF 0 CK votes >= 0) |
| R09 | comment(**id**, id_author -> user, id_event -> event NN, content NN, creation_date NN DF current_date CK creation_date <= current_date, number_upvotes NN DF 0 CK number_upvotes >= 0, number_downvotes NN DF 0 CK number_downvotes >= 0) |
| R10 | rating(**id_comment** -> comment, **id_reader** -> user, vote NN CK vote IN votes) |
| R11 | file(**id_comment** -> comment, path UK NN) |
| R12 | request(**id**, id_event -> event NN, date NN DF current_date CK date <= current_date, accepted NN DF false, id_requester -> user NN) |
| R13 | invite(**id**, id_event -> event NN, date NN DF current_date CK date <= current_date, accepted NN DF false, id_inviter -> user NN, id_invitee -> user NN CK id_inviter <> id_invitee) |
| R14 | report(**id**, id_author -> user NN, report_date NN DF current_date CK report_date <= current_date, motive NN, dismissal_date CK (dismissal_date == NULL OR (dismissal_date >= report_date AND dismissal_date <= current_date)) |
| R15 | user_report(**id_report** -> report, target -> user NN) |
| R16 | comment_report(**id_report** -> report, target -> comment NN, number_upvotes NN CK number_upvotes >= 0, number_downvotes NN CK number_downvotes >= 0) |
| R17 | event_report(**id_report** -> report, target -> event NN) | 
| R18 | transaction(**id**, id_user -> user NN, amount NN CK amount > 0, date NN DF current_date CK date <= current_date) |
| R19 | event_cancelled_notification(**id**, title NN, notification_date NN DF current_date CK notification_date <=  current_date)|
| R20 | attendee(**id_user** -> user, **id_event** -> event) |
| R21 | vote(**id_user** -> user, **id_option** -> option) |
| R22 | event_cancelled_notification_user(**id_notification** -> event_cancelled_notification, **id_user** -> user) |
| R23 | tag_event(**id_tag** -> tag, **id_event** -> event) |

Label:
- UK = Unique Key
- NN = Not Null
- DF = Default
- CK = Check

## 5.2 Domains
Specification of additional domains:

| Domain Name | Domain Specification |
| ----------- | -------------------- |
| current_date | DATE_DEFAULT CURRENT_DATE |
| votes | ENUM(‘Upvote’, ‘Downvote’) |


## 5.3 Schema Validation

| Table R01 | administrator |
| --- | --- |
| **Keys** | {id}, {username} |
| **Functional Dependencies** | |
| FD0101 | {id} → {username, password, last_login} |
| FD0102 | {username} →  {id, password, last_login} |
| **Normal Form** | BCNF |

| Table R02 | user |
| --- | --- |
| **Keys** | {id}, {username}, {email} |
| **Functional Dependencies** | |
| FD0201 |{id} → {username, email, password, name, profile_pic, account_creation_date, birthdate, description, block_motivel} |
| FD0202 | {username} →  {id, email, password, name, profile_pic, account_creation_date, birthdate, description, block_motivel} |
| FD0203 | {email} → {id, username, password, name, profile_pic, account_creation_date, birthdate, description, block_motivel} |
| **Normal Form** | BCNF |

| Table R03 | unblock_appeal |
| --- | --- |
| **Keys** | {id_user} |
| **Functional Dependencies** | |
| FD0301 | {id_user} → {message} |
| **Normal Form** | BCNF |

| Table R04 | event |
| --- | --- |
| **Keys** | {id} |
| **Functional Dependencies** | |
| FD0401 | {id} → {id_host, title, event_image, description, location, creation_date, realization_date, is_visible, is_acessible, capacity, price, number_attendees} |
| **Normal Form** | BCNF |

| Table R05 | tag |
| --- | --- |
| **Keys** | {id} |
| **Functional Dependencies** | |
| FD0501 | {id} → {name}|
| **Normal Form** | BCNF |

| Table R06 | post |
| --- | --- |
| **Keys** | {id} |
| **Functional Dependencies** | |
| FD0601 | {id} → {title, description, creation_date, id_event} |
| **Normal Form** | BCNF |

| Table R07 | poll |
| --- | --- |
| **Keys** | {id_post} |
| **Functional Dependencies** | *none* |
| **Normal Form** | BCNF |

| Table R08 | option |
| --- | --- |
| **Keys** | {id} |
| **Functional Dependencies** | |
| FD0801 | {id} → {id_poll, text, votes } |
| **Normal Form** | BCNF |

| Table R09 | comment |
| --- | --- |
| **Keys** | {id} |
| **Functional Dependencies** | |
| FD0901 | {id} → {id_author, id_event, id_poll, creation_date,number_downvotes,number_upvotes} |
| **Normal Form** | BCNF |

| Table R10 | rating |
| --- | --- |
| **Keys** |{id_comment, id_reader} |
| **Functional Dependencies** | |
| FD1001 |{id_comment, id_reader} → {vote} |
| **Normal Form** | BCNF |

| Table R11 | file |
| --- | --- |
| **Keys** | {id_comment} |
| **Functional Dependencies** | |
| FD1101 | {id_comment} → {path}|
| **Normal Form** | BCNF |

| Table R12 | request |
| --- | --- |
| **Keys** | {id} |
| **Functional Dependencies** | |
| FD1201 | {id} → {id_event, id_requester, date, accepted} |
| **Normal Form** | BCNF |

| Table R13 | invite |
| --- | --- |
| **Keys** |  {id} |
| **Functional Dependencies** | |
| FD1301 | {id} → {id_inviter, id_invitee, id_event, date, accepted} |
| **Normal Form** | BCNF |

| Table R14 | report |
| --- | --- |
| **Keys** |  {id} |
| **Functional Dependencies** | |
| FD1401 | {id} → {id_author, report_date, motive, dismissal_date} |
| **Normal Form** | BCNF |

| Table R15 | user_report |
| --- | --- |
| **Keys** |  {id_report} |
| **Functional Dependencies** | |
| FD1501 | {id_report} → {target} |
| **Normal Form** | BCNF |

| Table R16 | comment_report |
| --- | --- |
| **Keys** |  {id_report} |
| **Functional Dependencies** | |
| FD1601 | {id_report} → {target} |
| **Normal Form** | BCNF |

| Table R17 | event_report |
| --- | --- |
| **Keys** |  {id_report} |
| **Functional Dependencies** | |
| FD1701 | {id_report} → {target} |
| **Normal Form** | BCNF |

| Table R18 | transaction |
| --- | --- |
| **Keys** |  {id} |
| **Functional Dependencies** | |
| FD1801 | {id} → {id_user, amount, date} |
| **Normal Form** | BCNF |

| Table R19 | event_cancelled_notification |
| --- | --- |
| **Keys** |  {id} |
| **Functional Dependencies** | |
| FD1901 | {id} → {title, notification_date} |
| **Normal Form** | BCNF |

| Table R20 | attendee |
| --- | --- |
| **Keys** |  {id_user, id_event} |
| **Functional Dependencies** | *none* |
| **Normal Form** | BCNF |

| Table R21 | vote |
| --- | --- |
| **Keys** | {id_user, id_option} |
| **Functional Dependencies** | *none* |
| **Normal Form** | BCNF |

| Table R22 | event_cancelled_notification_user |
| --- | --- |
| **Keys** | {notification_id, user_id} |
| **Functional Dependencies** | *none* |
| **Normal Form** | BCNF |

| Table R23 | tag_event |
| --- | --- |
| **Keys** | {id_tag, id_event} |
| **Functional Dependencies** | *none* |
| **Normal Form** | BCNF |

Every table is in the Boyce-Codd Normal Form (BCNF), therefore the relation-schema is also in the BCNF and there is no need to further normalize them.

## Annex A. SQL Code

```sql
SET search_path TO lbaw2122;

-----------------------------------------
-- Drop Tables and Types
----------------------------------------- 

DROP TABLE IF EXISTS tag_event;
DROP TABLE IF EXISTS vote;
DROP TABLE IF EXISTS attendee;
DROP TABLE IF EXISTS event_cancelled_notification_user;
DROP TABLE IF EXISTS event_cancelled_notification;
DROP TABLE IF EXISTS transaction;
DROP TABLE IF EXISTS event_report;
DROP TABLE IF EXISTS comment_report;
DROP TABLE IF EXISTS user_report;
DROP TABLE IF EXISTS report;
DROP TABLE IF EXISTS file;
DROP TABLE IF EXISTS rating;
DROP TABLE IF EXISTS comment;
DROP TABLE IF EXISTS option;
DROP TABLE IF EXISTS poll;
DROP TABLE IF EXISTS post;
DROP TABLE IF EXISTS tag;
DROP TABLE IF EXISTS invite;
DROP TABLE IF EXISTS request;
DROP TABLE IF EXISTS event;
DROP TABLE IF EXISTS unblock_appeal;
DROP TABLE IF EXISTS users;
DROP TABLE IF EXISTS administrator;

-----------------------------------------
-- Types
-----------------------------------------

DROP TYPE IF EXISTS comment_rating CASCADE;
CREATE TYPE comment_rating AS ENUM ('Upvote', 'Downvote');

-----------------------------------------
-- Tables
-----------------------------------------

-- Note that a plural 'users' name was adopted because user is a reserved word in PostgreSQL.

CREATE TABLE administrator (
    id SERIAL PRIMARY KEY,
    username TEXT NOT NULL CONSTRAINT administrator_username_uk UNIQUE,
    password TEXT NOT NULL,
    last_login TIMESTAMP NOT NULL DEFAULT NOW() CONSTRAINT administrator_last_login_check CHECK (last_login <= NOW())
);

CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username TEXT NOT NULL CONSTRAINT user_username_uk UNIQUE,
    email TEXT NOT NULL CONSTRAINT user_email_uk UNIQUE CONSTRAINT user_email_check CHECK (email LIKE '%@%.%'),
    password TEXT NOT NULL,
    name TEXT NOT NULL,
    profile_pic TEXT,
    account_creation_date TIMESTAMP NOT NULL DEFAULT NOW() CONSTRAINT user_account_creation_date_check CHECK (account_creation_date <= NOW()),
    birthdate DATE NOT NULL,
    description TEXT,
    block_motive TEXT,
    CONSTRAINT user_birthdate_check CHECK (birthdate <= account_creation_date)
);

CREATE TABLE unblock_appeal (
    id_user SERIAL PRIMARY KEY REFERENCES users ON UPDATE CASCADE,
    message TEXT NOT NULL
);

CREATE TABLE event (
   id SERIAL PRIMARY KEY,
   id_host INTEGER NOT NULL REFERENCES users ON UPDATE CASCADE,
   title TEXT NOT NULL,
   event_image TEXT NOT NULL,
   description TEXT NOT NULL,
   location TEXT NOT NULL,
   creation_date TIMESTAMP NOT NULL DEFAULT NOW() CONSTRAINT event_creation_date_check CHECK (creation_date <= NOW()),
   realization_date TIMESTAMP NOT NULL,
   is_visible BOOLEAN NOT NULL,
   is_accessible BOOLEAN NOT NULL,
   capacity INT NOT NULL CHECK (capacity > 0),
   price DECIMAL(2) NOT NULL CHECK (price >= 0),
   number_attendees INT NOT NULL DEFAULT 0 CONSTRAINT event_number_attendees CHECK (number_attendees >= 0 AND number_attendees <= capacity),
   CONSTRAINT check_realization_date CHECK (creation_date < realization_date)
);

CREATE TABLE tag (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL CONSTRAINT tag_name_uk UNIQUE
);

CREATE TABLE post (
    id SERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    description TEXT NOT NULL,
    creation_date TIMESTAMP NOT NULL DEFAULT NOW() CONSTRAINT post_creation_date_check CHECK (creation_date <= NOW()),
    id_event INTEGER NOT NULL REFERENCES event ON UPDATE CASCADE ON DELETE CASCADE
);

CREATE TABLE poll (
    id_post INTEGER PRIMARY KEY REFERENCES post ON UPDATE CASCADE ON DELETE CASCADE
);

CREATE TABLE option (
    id SERIAL PRIMARY KEY,
    id_poll INTEGER NOT NULL REFERENCES poll ON UPDATE CASCADE ON DELETE CASCADE,
    description TEXT NOT NULL,
    votes INTEGER NOT NULL DEFAULT 0 CONSTRAINT option_votes_check CHECK (votes >= 0)
);

CREATE TABLE comment (
    id SERIAL PRIMARY KEY,
    id_author INTEGER REFERENCES users ON UPDATE CASCADE,
    id_event INTEGER NOT NULL REFERENCES event ON UPDATE CASCADE ON DELETE CASCADE,
    content TEXT NOT NULL,
    number_upvotes INTEGER NOT NULL DEFAULT 0 CONSTRAINT comment_number_upvotes CHECK (number_upvotes >= 0),
    number_downvotes INTEGER NOT NULL DEFAULT 0 CONSTRAINT comment_number_downvotes CHECK (number_downvotes >= 0),
    creation_date TIMESTAMP NOT NULL DEFAULT NOW() CONSTRAINT comment_creation_date_check CHECK (creation_date <= NOW())
);

CREATE TABLE rating (
    id_comment INTEGER REFERENCES comment ON UPDATE CASCADE,
    id_reader INTEGER REFERENCES users ON UPDATE CASCADE,
    vote comment_rating NOT NULL,
    PRIMARY KEY (id_comment, id_reader)
);

CREATE TABLE file (
    id_comment INTEGER PRIMARY KEY REFERENCES comment ON UPDATE CASCADE ON DELETE CASCADE,
    path TEXT NOT NULL CONSTRAINT file_path_uk UNIQUE
);

CREATE TABLE request (
    id SERIAL PRIMARY KEY,
    id_event INTEGER NOT NULL REFERENCES event ON UPDATE CASCADE ON DELETE CASCADE,
    date TIMESTAMP NOT NULL DEFAULT NOW() CONSTRAINT request_date_check CHECK (date <= NOW()),
    accepted BOOLEAN NOT NULL DEFAULT false,
    id_requester INTEGER NOT NULL REFERENCES users ON UPDATE CASCADE
);

CREATE TABLE invite (
    id SERIAL PRIMARY KEY,
    id_event INTEGER NOT NULL REFERENCES event ON UPDATE CASCADE ON DELETE CASCADE,
    date TIMESTAMP NOT NULL DEFAULT NOW() CONSTRAINT invite_date_check CHECK (date <= NOW()),
    accepted BOOLEAN NOT NULL DEFAULT false,
    id_inviter INTEGER NOT NULL REFERENCES users ON UPDATE CASCADE,
    id_invitee INTEGER NOT NULL REFERENCES users ON UPDATE CASCADE,
    CONSTRAINT invite_invitter_invitee_id_check CHECK (id_inviter <> id_invitee)
);

CREATE TABLE report (
    id SERIAL PRIMARY KEY,
    id_author INTEGER NOT NULL REFERENCES users ON UPDATE CASCADE,
    report_date TIMESTAMP NOT NULL DEFAULT NOW() CONSTRAINT report_date_check CHECK (report_date <= NOW()),
    motive TEXT NOT NULL,
    dismissal_date TIMESTAMP CONSTRAINT report_dismissal_date_check1 CHECK (dismissal_date <= NOW()),
    CONSTRAINT report_dismissal_date_check2 CHECK (dismissal_date IS NULL OR (dismissal_date >= report_date AND dismissal_date <= NOW()))
);

CREATE TABLE user_report (
    id_report INTEGER PRIMARY KEY REFERENCES report ON UPDATE CASCADE,
    target INTEGER NOT NULL REFERENCES users ON UPDATE CASCADE
);

CREATE TABLE comment_report (
    id_report INTEGER PRIMARY KEY REFERENCES report,
    target INTEGER NOT NULL REFERENCES comment ON UPDATE CASCADE
);

CREATE TABLE event_report (
    id_report INTEGER PRIMARY KEY REFERENCES report ON UPDATE CASCADE,
    target INTEGER NOT NULL REFERENCES event ON UPDATE CASCADE
);

CREATE TABLE transaction (
    id SERIAL PRIMARY KEY,
    id_user INTEGER NOT NULL REFERENCES users ON UPDATE CASCADE,
    amount DECIMAL(2) NOT NULL CONSTRAINT transaction_amount_check CHECK(amount > 0),
    date TIMESTAMP NOT NULL DEFAULT NOW() CONSTRAINT transaction_date_check CHECK (date <= NOW())
);

CREATE TABLE event_cancelled_notification (
    id SERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    notification_date TIMESTAMP NOT NULL DEFAULT NOW() CONSTRAINT event_cancelled_notification_check CHECK (notification_date <= NOW())
);

CREATE TABLE attendee (
    id_user INTEGER REFERENCES users ON UPDATE CASCADE,
    id_event INTEGER REFERENCES event ON UPDATE CASCADE,
    PRIMARY KEY (id_user, id_event)
);

CREATE TABLE vote (
    id_user INTEGER REFERENCES users,
    id_option INTEGER REFERENCES option ON UPDATE CASCADE ON DELETE CASCADE,
    PRIMARY KEY (id_user, id_option)
);

CREATE TABLE event_cancelled_notification_user (
    id_notification INTEGER REFERENCES event_cancelled_notification ON UPDATE CASCADE ON DELETE CASCADE,
    id_user INTEGER REFERENCES users ON UPDATE CASCADE,
    PRIMARY KEY (id_notification, id_user)
);

CREATE TABLE tag_event (
    id_tag INTEGER REFERENCES tag ON UPDATE CASCADE,
    id_event INTEGER REFERENCES event ON UPDATE CASCADE ON DELETE CASCADE,
    PRIMARY KEY (id_tag, id_event)
);
```